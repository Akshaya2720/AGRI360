<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SupplyCo Command | Agri-Escrow 360</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-open #modalContent {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>

<body class="mesh-bg flex">
    <div class="dashboard-layout w-full">
        <!-- Sidebar -->
        <aside class="sidebar animate-fade-in">
            <div class="flex items-center gap-4 mb-20">
                <div style="background: var(--primary); padding: 0.6rem; border-radius: 16px; color: white;">
                    <i data-lucide="command" size="28" stroke-width="2.5"></i>
                </div>
                <span class="font-display font-black text-3xl tracking-tighter">Agri<span
                        class="emerald-600">360</span></span>
            </div>

            <nav style="flex: 1;">
                <a href="dashboard-supplyco.html" class="nav-item active">
                    <i data-lucide="layout-grid" size="20"></i>
                    <span data-i18n="nav_dashboard">Hub Center</span>
                </a>
                <a href="#" class="nav-item">
                    <i data-lucide="file-check" size="20"></i>
                    <span data-i18n="nav_harvest">Approval Queue</span>
                </a>
                <a href="logistics-node.html" class="nav-item">
                    <i data-lucide="truck" size="20"></i>
                    <span data-i18n="nav_logistics">Logistics Hub</span>
                </a>
                <a href="yield-analytics-supplyco.html" class="nav-item">
                    <i data-lucide="pie-chart" size="20"></i>
                    <span data-i18n="nav_yield_supplyco">Procurement Analytics</span>
                </a>
            </nav>

            <div class="pt-10 border-t border-gray-100">
                <div class="flex items-center gap-4 mb-8 grayscale hover:grayscale-0 transition-all duration-500">
                    <div
                        style="width: 48px; height: 48px; border-radius: 16px; background: var(--bg); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="user-cog" size="24" class="gray-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-black tracking-tight" id="sidebarUserName">SupplyCo Officer</p>
                        <p class="text-[9px] font-black uppercase tracking-widest emerald-600">Enterprise Node 0x01</p>
                    </div>
                </div>
                <a href="#" class="nav-item !text-red-500 hover:!bg-red-50" onclick="logout()">
                    <i data-lucide="log-out" size="20"></i>
                    <span data-i18n="logout">Terminate session</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex flex-col min-h-screen">
            <header class="flex justify-between items-center mb-20 animate-fade-in">
                <div>
                    <h1 class="text-6xl italic font-display leading-[0.8]">
                        SupplyCo <br>
                        <span class="emerald-600 NOT-italic uppercase tracking-tighter">Command Center</span>
                    </h1>
                    <p class="text-sm gray-400 font-bold tracking-widest uppercase mt-6">
                        Regional Oversight • <span class="emerald-600 animate-pulse">Master Node Active</span>
                    </p>
                </div>

                <div class="flex items-center gap-6">
                    <div class="glass-pill flex items-center gap-3">
                        <i data-lucide="shield-check" size="16" class="emerald-600"></i>
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-900">Encrypted
                            Session</span>
                    </div>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-3 gap-12 mb-20">
                <div class="card-premium">
                    <p class="text-[10px] font-black uppercase tracking-widest gray-400 mb-2">Pending Approvals</p>
                    <h3 class="text-5xl font-black italic tracking-tighter">142 <span
                            class="text-xl gray-400 NOT-italic font-bold">Files</span></h3>
                    <div
                        class="mt-8 pt-6 border-t border-gray-100 flex items-center gap-2 text-amber-500 font-bold text-xs">
                        <i data-lucide="clock" size="14"></i> Resolution time: 4.2h
                    </div>
                </div>

                <div class="card-premium">
                    <p class="text-[10px] font-black uppercase tracking-widest gray-400 mb-2">State Procurement</p>
                    <h3 class="text-5xl font-black italic tracking-tighter">₹84.2<span
                            class="text-xl gray-400 NOT-italic font-bold">Cr</span></h3>
                    <div
                        class="mt-8 pt-6 border-t border-gray-100 flex items-center gap-2 text-emerald-600 font-bold text-xs">
                        <i data-lucide="trending-up" size="14"></i> 4% above forecast
                    </div>
                </div>

                <div class="card-premium">
                    <p class="text-[10px] font-black uppercase tracking-widest gray-400 mb-2">Mill Queue Status</p>
                    <h3 class="text-5xl font-black italic tracking-tighter">84<span
                            class="text-xl gray-400 NOT-italic font-bold">%</span></h3>
                    <div
                        class="mt-8 pt-6 border-t border-gray-100 flex items-center gap-2 text-emerald-600 font-bold text-xs">
                        <i data-lucide="zap" size="14"></i> Optimal throughput
                    </div>
                </div>
            </div>

            <!-- Queue Section -->
            <div class="card-premium flex-1 mb-20 animate-fade-in-up">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-3xl font-black italic tracking-tight">Procurement <span class="emerald-600">Queue
                            Node</span></h2>
                    <div class="flex gap-4">
                        <button class="bg-gray-50 border p-3 rounded-xl hover:bg-white transition-all"><i
                                data-lucide="filter" size="18" class="gray-400"></i></button>
                        <button class="bg-gray-50 border p-3 rounded-xl hover:bg-white transition-all" onclick="loadQueue()"><i
                                data-lucide="refresh-cw" size="18" class="gray-400"></i></button>
                    </div>
                </div>

                <div id="queueList" class="space-y-4">
                    <div class="flex flex-col items-center justify-center p-20 text-center">
                        <i data-lucide="loader-2" class="animate-spin emerald-600 mb-4" size="32"></i>
                        <p class="gray-400 italic font-bold">Syncing procurement queue...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Approval Modal -->
    <div id="approvalModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-md transition-all duration-300 opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] p-10 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 border border-white/20"
            id="modalContent">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-3xl font-black italic tracking-tight">Authorize <span
                            class="emerald-600">Payout</span></h3>
                    <p class="text-xs font-bold gray-400 uppercase tracking-widest mt-2">Submission #<span
                            id="modalId">--</span></p>
                </div>
                <button onclick="closeModal()" class="p-3 rounded-full hover:bg-gray-50 transition-colors">
                    <i data-lucide="x" size="24" class="gray-400"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-8">
                <div class="p-6 bg-gray-50 rounded-[2rem] border border-gray-100">
                    <p class="text-[10px] font-black uppercase tracking-widest gray-400 mb-4">Quality Vector</p>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-sm font-bold text-slate-700">Moisture</span>
                        <span class="text-xl font-black text-slate-900" id="modalMoisture">--%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mb-4">
                        <div class="bg-emerald-500 h-1.5 rounded-full" style="width: 85%"></div>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-sm font-bold text-slate-700">AI Grade</span>
                        <span class="tag tag-success" id="modalGrade">A+</span>
                    </div>
                </div>

                <div class="p-6 bg-emerald-50 rounded-[2rem] border border-emerald-100">
                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-600 mb-4">Escrow Release</p>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-sm font-bold text-slate-700">Net Weight</span>
                        <span class="text-xl font-black text-emerald-800" id="modalWeight">-- KG</span>
                    </div>
                    <div class="flex justify-between items-end mt-4">
                        <span class="text-sm font-bold text-slate-700">Total Fund</span>
                        <span class="text-3xl font-black text-emerald-600">₹<span id="modalAmount">--</span></span>
                    </div>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="closeModal()"
                    class="btn-secondary flex-1 !bg-red-50 !text-red-600 !border-red-100 hover:!bg-red-100">Reject
                    Node</button>
                <button onclick="confirmApproval()" class="btn-primary flex-1">
                    <i data-lucide="check-circle" size="18" class="mr-2"></i> Sign & Disburse
                </button>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="i18n.js"></script>
    <script>
        lucide.createIcons();
        const user = getUser();
        if (!user || user.role !== 'SUPPLYCO_OFFICER') window.location.href = 'login.html';
        document.getElementById('sidebarUserName').textContent = user.name || 'SupplyCo Officer';

        let currentSubmission = null;

        async function loadQueue() {
            try {
                const submissions = await apiRequest('/supplyco/queue');
                const container = document.getElementById('queueList');

                if (!submissions || submissions.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-20 text-center border border-dashed border-gray-200 rounded-[3rem]">
                            <p class="gray-400 italic font-bold">No pending approvals in the queue.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = submissions.map(item => `
                    <div class="flex items-center justify-between p-8 bg-white border border-gray-100 rounded-[2.5rem] hover:shadow-lg hover:border-emerald-100 transition-all duration-500 group">
                        <div class="flex items-center gap-6">
                            <div style="background: var(--bg); padding: 1.25rem; border-radius: 20px; color: var(--text-muted);" class="group-hover:scale-110 transition-transform">
                                <i data-lucide="package" size="24"></i>
                            </div>
                            <div>
                                <p class="text-lg font-black tracking-tight">${item.farmerName || 'Farmer Node'} <span class="text-xs gray-400 uppercase font-bold ml-2">#NODE-${item.id.toString().slice(-4)}</span></p>
                                <p class="text-[10px] font-black gray-400 uppercase tracking-widest mt-1">${item.cropType} • ${item.quantityKg} KG • ${new Date(item.createdAt).toLocaleDateString()}</p>
                            </div>
                        </div>

                        <div class="flex gap-12 items-center">
                            <div class="text-center">
                                <p class="text-[9px] font-black gray-400 uppercase tracking-widest mb-2">AI Risk</p>
                                <div class="tag ${item.riskScore < 0.3 ? 'tag-success' : 'tag-warning'}">${item.riskScore < 0.3 ? 'Low Risk' : 'Review'}</div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick='openApprovalModal(${JSON.stringify(item).replace(/'/g, "&apos;")})' class="btn-primary !py-3 !px-6 !text-xs shadow-lg shadow-emerald-100">Inspect & Authorize</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (err) {
                console.error(err);
                document.getElementById('queueList').innerHTML = `
                     <div class="flex flex-col items-center justify-center p-20 text-center border border-dashed border-gray-200 rounded-[3rem]">
                        <p class="text-red-400 italic font-bold">Connection Node Offline. Retrying...</p>
                    </div>
                `;
            }
        }

        function openApprovalModal(item) {
            currentSubmission = item;
            document.getElementById('modalId').textContent = item.id.toString().slice(-4);
            document.getElementById('modalMoisture').textContent = (item.moisture || 13.5) + '%';
            document.getElementById('modalWeight').textContent = item.quantityKg + ' KG';

            // Calculate amount (mock rate if not provided)
            const rate = item.cropType === 'Matta' ? 28.2 : 26.5;
            const amount = Math.round(item.quantityKg * rate);
            document.getElementById('modalAmount').textContent = amount.toLocaleString();

            const modal = document.getElementById('approvalModal');
            modal.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                modal.classList.add('modal-open');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('approvalModal');
            modal.classList.remove('modal-open');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            currentSubmission = null;
        }

        async function confirmApproval() {
            if (!currentSubmission) return;
            const btn = document.querySelector('#approvalModal .btn-primary');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin mr-2"></i> Processing...';
                lucide.createIcons();

                await apiRequest(`/supplyco/approve/${currentSubmission.id}`, { method: 'POST' });
                
                closeModal();
                loadQueue(); // Refresh list
            } catch (err) {
                alert('Approval failed: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Initialize
        loadQueue();

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>